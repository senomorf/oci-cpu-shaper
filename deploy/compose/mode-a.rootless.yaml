version: "3.9"

services:
  shaper:
    image: ${SHAPER_IMAGE:-oci-cpu-shaper:nonroot}
    container_name: ${SHAPER_CONTAINER_NAME:-oci-cpu-shaper}
    user: ${SHAPER_USER:-65532:65532}
    command:
      - "--config"
      - "/etc/oci-cpu-shaper/config.yaml"
      - "--mode"
      - "${SHAPER_MODE:-dry-run}"
      - "--log-level"
      - "${SHAPER_LOG_LEVEL:-info}"
    env_file:
      - ${SHAPER_ENV_FILE:-./deploy/compose/mode-a.env.example}
    volumes:
      - ${SHAPER_CONFIG_PATH:-./configs/mode-a.yaml}:/etc/oci-cpu-shaper/config.yaml:ro
    read_only: true
    tmpfs:
      - /tmp
    ports:
      - ${SHAPER_METRICS_BIND:-127.0.0.1:9108}:9108
    security_opt:
      - no-new-privileges:true
    cpu_shares: ${SHAPER_CPU_SHARES:-128}
    restart: "unless-stopped"
